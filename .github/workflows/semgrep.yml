name: Semgrep SAST and SCA Scan
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  semgrep-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm install
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Semgrep
        run: |
          pip install semgrep
          semgrep --version
      - name: Verify app.js exists
        run: |
          if [ ! -f app.js ]; then
            echo "Error: app.js not found"
            exit 1
          fi
          ls -l app.js
      - name: Run Semgrep SAST
        env:
          SEMGREP_TOKEN: ${{ secrets.SEMGREP_TOKEN }}
        run: |
          semgrep --config=r/javascript.express.security.xss.express-xss --config=r/javascript.express.security.insecure-cookie.insecure-cookie --config=r/javascript.express.security.cors.express-cors --config=r/javascript.nodejs.security.command-injection.command-injection --config=r/javascript.lang.security.eval.eval --config=r/javascript.nodejs.security.sql-injection.sql-injection app.js --severity ERROR --json --output=semgrep-sast-results.json --verbose
          cat semgrep-sast-results.json
          jq -e '.results | length > 0' semgrep-sast-results.json && { echo "Vulnerabilities found, failing workflow"; exit 1; }
      - name: Run Semgrep SCA
        env:
          SEMGREP_TOKEN: ${{ secrets.SEMGREP_TOKEN }}
        run: |
          semgrep --config=p/supply-chain --json --output=semgrep-sca-results.json --verbose
          cat semgrep-sca-results.json
      - name: Upload Semgrep results
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: |
            semgrep-sast-results.json
            semgrep-sca-results.json